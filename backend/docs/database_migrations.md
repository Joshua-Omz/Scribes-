# Database Migrations with Alembic

This document explains how to use Alembic for database migrations in the Scribes backend.

## Overview

Alembic is a lightweight database migration tool for SQLAlchemy. It's used in this project to manage database schema changes in a version-controlled way.

## Directory Structure

- `alembic/`: The main Alembic directory
  - `versions/`: Contains migration scripts
  - `env.py`: Alembic environment configuration
  - `script.py.mako`: Template for new migration scripts
- `alembic.ini`: Alembic configuration file

## Current Setup

The project is set up to use Alembic with SQLAlchemy models. The database URL is read from the application settings.

### Current Models

1. **User Model**: Stores user authentication data
   - Fields: id, email, username, hashed_password, full_name, is_active, is_superuser, created_at, updated_at

2. **RefreshToken Model**: Stores JWT refresh tokens
   - Fields: id, token, user_id, expires_at, revoked, created_at, updated_at

## Common Commands

### Creating a New Migration

To create a new migration after changing your models:

```bash
# Navigate to project root
cd "path\to\project"

# Activate virtual environment
.\venv\Scripts\Activate

# Create a new migration with auto-detection of changes
alembic revision --autogenerate -m "Description of changes"
```

### Running Migrations

To apply migrations to the database:

```bash
# Apply all pending migrations
alembic upgrade head

# Apply specific migration
alembic upgrade <revision>

# Rollback one migration
alembic downgrade -1

# Rollback to a specific migration
alembic downgrade <revision>
```

### Getting Migration Information

```bash
# Show current migration version
alembic current

# Show migration history
alembic history

# Show pending migrations
alembic history -i
```

## Best Practices

1. **Always review autogenerated migrations** before applying them to ensure they're correct.
2. **Test migrations** on a development database before applying to production.
3. **Back up your database** before running migrations in production.
4. **Commit migration scripts** to version control to track schema changes.
5. **Use meaningful descriptions** for your migrations to make their purpose clear.

## Troubleshooting

### Common Issues

1. **Database connection errors**: Make sure your database is running and the connection settings in `app/config.py` are correct.
2. **Migration conflicts**: If multiple developers create migrations simultaneously, conflicts can occur. Coordinate changes or manually resolve conflicts.
3. **Model import errors**: Ensure all models are properly imported in `alembic/env.py`.
